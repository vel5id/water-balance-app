# Срочно: Бэк-тест прогноза за 2024 год

Цель: Оценить состоятельность модели прогноза объёма/баланса, построив прогноз на 2024 год, используя только данные 2022–2023 годов (обучающая/калибровочная выборка), и сравнить прогноз с фактическими значениями 2024.

## 1. Постановка задачи
- Обучить сезонно-трендовую и/или климатологическую модель на периоде: 2022-01-01 .. 2023-12-31.
- Сгенерировать прогноз на горизонт: 2024-01-01 .. 2024-12-31.
- Сравнить прогноз с фактическими данными за 2024 (осадки, испарение, уровень/объём).
- Получить метрики точности + визуализацию (временные ряды, ошибки, распределения остатка).

## 2. Данные
Минимально требуемые ряды:
- Осадки: `precip_mm` (суточные агрегаты)
- Испарение: `evaporation_mm` или эквивалентное поле из GLEAM
- (Опционально) Сценарные / фактические объёмы: если есть измеренные уровни/объёмы за 2024
- Площадь/кривая объём-площадь: для трансформации уровня ↔ объём

Проверить целостность:
1. Нет ли пропусков > 5 подряд дней в 2022-2023.
2. Формат даты нормализован: `datetime64[ns]`, без часовых зон, `.dt.normalize()`.
3. Единицы осадков и испарения приведены к мм/день.

## 3. Методология прогноза
Используем два подхода для сравнения:
1. Climatology (климатология): среднее/медиана по дню года (DOY) или месяцу за 2022-2023, повторённое на 2024.
2. Season + Trend (Theil–Sen): текущая функция `build_robust_season_trend_series` — строим сезонную компоненту + тренд, экстраполируем на 2024.

Дополнительно (если уже реализовано):
- Ensemble (блок-бутстрап по остаткам) для построения доверительного интервала будущих осадков/испарения и трансляции в диапазон объёмов.

## 4. Шаги выполнения
### 4.1 Подготовка фильтра обучающих данных
- Отфильтровать исходный DataFrame ERA5/GLEAM: `train_mask = (date >= '2022-01-01') & (date <= '2023-12-31')`.
- `train_df = full_df.loc[train_mask].copy()`
- Аналогично выделить валидационный интервал 2024: `valid_df`.

### 4.2 Построение осадков (deterministic forecast)
```python
from wbm.forecast import build_robust_season_trend_series
train_p = train_df['precip_mm']
res_p = build_robust_season_trend_series(train_p, freq='doy', future_days=366, min_history=120)
forecast_p_2024 = res_p.deterministic[res_p.dates.year==2024]
```
Если недостаточно данных → fallback на климатологию:
```python
clim_map = train_p.groupby(train_p.index.dayofyear).median()
forecast_p_2024 = pd.Series(
    [clim_map.get(doy, clim_map.median()) for doy in pd.date_range('2024-01-01','2024-12-31').dayofyear],
    index=pd.date_range('2024-01-01','2024-12-31')
)
```

### 4.3 Испарение аналогично
```python
train_et = train_df['evaporation_mm']
res_et = build_robust_season_trend_series(train_et, freq='doy', future_days=366, min_history=120)
forecast_et_2024 = res_et.deterministic[res_et.dates.year==2024]
```
Fallback → дневная/месячная климатология.

### 4.4 Моделирование объёма
Использовать имеющийся механизм сценария:
1. Стартовый объём = последний доступный объём/расчёт на 2023-12-31.
2. Прогон модели по дням 2024 с прогнозными P и ET, фиксируя или моделируя приток/сток (если параметры заданы).
3. Сохранить временной ряд `volume_mcm_forecast`.
4. Если есть фактический `volume_mcm_actual_2024` — объединить по дате.

### 4.5 Ensemble (опционально)
- Выполнить бутстрап остатка осадков/испарения (если реализовано в UI) для получения распределения объёмов.
- Вычислить интервалы (Q5, Q50, Q95) для каждого дня.

## 5. Метрики оценки
Для P и ET:
- MAE, RMSE, MAPE (где применимо)
- Bias (средняя ошибка)

Для объёма:
- MAE, RMSE между прогнозом и фактом
- NSE (Nash–Sutcliffe Efficiency) если подходит
- Кросс-корреляция (лаг 0 и +/- 1..7 дней)

Формулы:
```python
mae = (abs(y_true - y_pred)).mean()
rmse = ((y_true - y_pred)**2).mean()**0.5
bias = (y_pred - y_true).mean()
mape = (abs((y_true - y_pred) / y_true.clip(lower=1e-6))).mean()*100
```

## 6. Визуализация
- График времени: факт vs прогноз (P, ET, Volume)
- График ошибки (y_true - y_pred)
- Гистограмма остатков
- (Ensemble) Лента доверительного интервала vs факт

## 7. Критерии успешности
- Ошибка по объёму: RMSE <= X% от среднего объёма (уточнить порог, например 8–12%).
- Отсутствие существенного смещения (|Bias| < 5% среднего).
- Для осадков: MAPE < 25% (или сопоставимое с «наивной» климатологией). Если сезонно-трендовая модель даёт >=5% улучшение RMSE против климатологии — считаем оправданной.

## 8. Отчёт
Сформировать `backtest_2024_report.md`:
- Таблица метрик
- Краткое резюме улучшения против базовой климатологии
- 2–4 ключевых графика
- Выводы и потенциальные улучшения (напр. необходимость сглаживания, переразбиение сезонности, учёт аномалий).

## 9. Потенциальные риски / ловушки
- Пропуски в начале 2022 снижают min_history → нужно адаптивное снижение как уже сделано в ensemble.
- Аномалия одного года (например, экстремально влажный 2023) исказит тренд → возможен robust z-score filter.
- Високосный день: 2024 — високосный; нужно безопасно маппить DOY 366.

## 10. Чеклист выполнения
- [ ] Проверены и очищены данные 2022-2023
- [ ] Построены deterministic прогнозы P и ET на 2024
- [ ] Выполнен расчёт объёма на 2024
- [ ] Собраны фактические данные 2024 (P, ET, объём)
- [ ] Посчитаны метрики P/ET/Volume
- [ ] Сформированы визуализации
- [ ] Сравнение с климатологией готово
- [ ] Собран отчёт `backtest_2024_report.md`
- [ ] Приняты критерии успешности или зафиксированы отклонения

## 11. Автоматизация (дополнительно)
Создать скрипт `backtest_2024.py`:
- Аргументы: `--data-root`, `--out-dir`.
- Внутри выполняет шаги 4.1–4.5, 5, 6, сохраняет графики и отчёт.

---
Ответственный: (указать)
Срок первичного черновика: YYYY-MM-DD (<= 7 дней от текущей даты)

