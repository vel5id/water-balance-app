from __future__ import annotations
"""i18n module with RU (default), EN, KK (Kazakh).
Add new keys to TRANSLATIONS.
"""
from dataclasses import dataclass
from typing import Dict

TRANSLATIONS: Dict[str, Dict[str, str]] = {
    "ru": {
        "app_title": "Интерактивная модель водного баланса",
        "tagline": "Сценарное моделирование и диагностика",
        "lang_ru": "Русский",
        "lang_en": "English",
        "lang_kk": "Қазақ",
        "baseline_info": "Базовая информация",
        "no_baseline": "Базовый ряд не найден – сценарий всё равно можно рассчитать.",
        "scenario_controls": "Параметры сценария",
        "data_filtering": "Фильтрация данных",
        "min_area": "Мин. площадь (км²)",
        "filter_baseline": "Фильтровать базу по мин. площади",
        "hide_below": "Скрыть сценарий ниже порога (графики)",
        "view_section": "Просмотр",
        "display_range": "Диапазон",
        "all_period": "Весь период",
        "single_year": "Один год",
        "smoothing_window": "Окно сглаживания (дн.)",
        "forecast_mode": "Режим прогноза",
        "monthly_mean": "Среднее по месяцам",
        "seasonal_clim": "Сезонная климатология",
        "seasonal_trend": "Сезон + тренд",
        "season_trend_opts": "Параметры Сезон+Тренд",
        "history_window": "Окно истории (дней)",
        "season_basis": "База сезона",
        "basis_doy": "День года",
        "basis_month": "Месяц",
        "season_smooth": "Сглаживание сезона (дн.)",
        "centering": "Центрирование",
        "median": "медиана",
        "mean": "среднее",
        "clim_missing": "Нет климатологии: добавьте precipitation_volume_mcm и evaporation_volume_mcm.",
        "download": "Скачать сценарий CSV",
        "end_volume": "Конечный объём (млн м³)",
        "min_volume": "Мин. объём (млн м³)",
        "max_volume": "Макс. объём (млн м³)",
        "daily_pet": "Суточные объёмы P/ET",
        "trends_corr": "Тренды и корреляции",
        "no_scenario_data": "Нет данных сценария.",
        "rolling_window_days": "Окно скользящего тренда (дни)",
        "max_lag_corr": "Макс. лаг для корреляции (дни)",
        "lagged_corr_area": "Лаговые корреляции с площадью",
        "missing_columns": "Отсутствуют колонки для анализа: {cols}",
        "long_term_trends": "Долгосрочные тренды P & ET",
        "era5_insufficient": "Недостаточно данных ERA5 для трендов.",
        "years_back": "Лет назад",
        "aggregation": "Агрегация",
        "monthly": "Месячная",
        "annual": "Годовая",
        "not_enough_agg": "Недостаточно агрегированных данных.",
        "p_slope": "Тренд P (мм/день/год)",
        "et_slope": "Тренд ET (мм/день/год)",
        "snow_temp_trends": "Снег vs Температура",
        "display_agg": "Агрегация отображения",
        "clip_ratio": "Ограничить отношение ±",
        "rolling_trends_ratio": "Скользящие тренды и их отношение",
        "runoff_temp_trends": "Сток vs Температура",
        "max_lag_temp_runoff": "Макс. лаг для t→сток (дни)",
        "lagged_corr_runoff_temp": "Лаговая корреляция: сток vs температура",
        "p_et_diag": "Диагностика осадков и испарения",
        "p_et_ratio_clip": "Ограничить P/ET ±",
        "phase_plots": "Сезонные фазовые петли",
        "x_variable": "X переменная",
        "y_variable": "Y переменная",
        "color_by": "Цвет по",
        "years": "Годы",
        "smoothing_days": "Сглаживание (дни)",
        "show_markers": "Показывать маркеры",
        "select_diff_vars": "Выберите разные переменные.",
        "ensemble_forecast": "Ансамблевый прогноз (экспериментально)",
        "enable_ensemble": "Включить ансамбль",
        "members_n": "Число членов (N)",
        "history_window_days": "Окно истории (дни)",
        "season_basis_opt": "База сезона",
        "seasonal_smooth_window": "Сглаживание сезона (дни)",
        "residual_bootstrap": "Блочный бутстрэп остатков",
        "block_length_mode": "Режим длины блока",
        "block_length": "Длина блока (дни)",
        "quantile_range": "Диапазон квантилей",
        "map_title": "Карта водоёма: смоделированная акватория",
        "water_overlay_opacity": "Прозрачность воды",
        "visualization_day": "День визуализации",
        "base_background": "Подложка",
        "water_mask_mode": "Режим маски воды",
        "simulated_level": "Смоделированный уровень",
        "depth_ndwi": "Глубина & NDWI",
        "download_csv": "Скачать сценарий CSV",
    "language_label": "Язык / Language",
    "initial_volume": "Начальный объём",
    "source_label": "Источник",
    "min_area_to_volume": "Мин. площадь ⇒ объём ≥ {vol:.1f} млн м³",
    "reservoir_timeseries_title": "Динамика объёма водохранилища",
    "baseline_volume_name": "База (объём, млн м³)",
    "scenario_volume_name": "Сценарий (объём, млн м³)",
    "date_axis": "Дата",
    "volume_axis": "Объём (млн м³)",
    "daily_p_et_title": "Суточные объёмы P и ET (млн м³/день)",
    "p_bar": "P (млн м³/день)",
    "et_bar": "ET (млн м³/день)",
    "bathymetry_missing": "Файл батиметрии не найден; карта отключена.",
    "vol_elev_missing": "Отсутствует привязка Объём→Отметка (нет elevation_m).",
    "default_sim_level_mode": "Режим моделируемого уровня по умолчанию.",
    "ndwi_mask_missing": "Маска NDWI отсутствует или искажена; показана только глубина (dem<0).",
    "dynamic_depth_caption": "Динамический режим глубины: доля площади={frac:.3f}",
    "dem_stats": "Статистика ЦМР — min: {dmin:.2f}, max: {dmax:.2f}, mean: {dmean:.2f}",
    "daily": "Суточно",
    "loading_data": "Загрузка данных...",
    "footer_caption": "Модульный интерфейс – легаси версии сохранены в _legacy/",
    "year": "Год",
    "season_trend_docs": "Метод Сезон+Тренд (документация)",
    "volume_word": "Объём",
    "mcm_unit": "млн м³",
    "dem_label": "ЦМР",
    "mask_label": "Маска",
    "level_word": "Уровень",
    "m_unit": "м",
    "removed_rows_area": "{n} ↓ площадь < {min_area:.1f} км²",
    "curve_missing": "Отсутствует кривая площадь-объём. Запустите препроцессинг.",
    },
    "en": {
        "app_title": "Water Balance Interactive Model",
        "tagline": "Scenario simulation and diagnostics",
        "lang_ru": "Русский",
        "lang_en": "English",
        "lang_kk": "Қазақ",
        "baseline_info": "Baseline info",
        "no_baseline": "Baseline series not found – scenario still runnable.",
        "scenario_controls": "Scenario Controls",
        "data_filtering": "Data filtering",
        "min_area": "Min area (km²)",
        "filter_baseline": "Filter baseline by min area",
        "hide_below": "Hide scenario below threshold (plots)",
        "view_section": "View",
        "display_range": "Range",
        "all_period": "All period",
        "single_year": "Single year",
        "smoothing_window": "Smoothing window (days)",
        "forecast_mode": "Forecast mode",
        "monthly_mean": "Monthly mean",
        "seasonal_clim": "Seasonal climatology",
        "seasonal_trend": "Seasonal + trend",
        "season_trend_opts": "Season+Trend options",
        "history_window": "History window (days)",
        "season_basis": "Season basis",
        "basis_doy": "DOY",
        "basis_month": "MONTH",
        "season_smooth": "Seasonal smooth (days)",
        "centering": "Centering",
        "median": "median",
        "mean": "mean",
        "clim_missing": "Climatology missing: add precipitation_volume_mcm & evaporation_volume_mcm.",
        "download": "Download scenario CSV",
        "end_volume": "End Volume (mcm)",
        "min_volume": "Min Volume (mcm)",
        "max_volume": "Max Volume (mcm)",
        "daily_pet": "Daily P/ET volumes",
        "trends_corr": "Trends and correlations",
        "no_scenario_data": "No scenario data.",
        "rolling_window_days": "Rolling window (days)",
        "max_lag_corr": "Max lag for correlation (days)",
        "lagged_corr_area": "Lagged correlations with area",
        "missing_columns": "Missing columns for trend analysis: {cols}",
        "long_term_trends": "Long-term P & ET trends",
        "era5_insufficient": "ERA5 data insufficient for long-term trends.",
        "years_back": "Years back",
        "aggregation": "Aggregation",
        "monthly": "Monthly",
        "annual": "Annual",
        "not_enough_agg": "Not enough aggregated data.",
        "p_slope": "P slope (mm/day/yr)",
        "et_slope": "ET slope (mm/day/yr)",
        "snow_temp_trends": "Snow vs Temperature Trends",
        "display_agg": "Display aggregation",
        "clip_ratio": "Clip ratio at ±",
        "rolling_trends_ratio": "Rolling trends and their ratio",
        "runoff_temp_trends": "Runoff vs Temperature Trends",
        "max_lag_temp_runoff": "Max lag for temp→runoff corr (days)",
        "lagged_corr_runoff_temp": "Lagged correlation: runoff vs temperature",
        "p_et_diag": "Precipitation & Evaporation Diagnostics",
        "p_et_ratio_clip": "Clip P/ET ratio at ±",
        "phase_plots": "Seasonal Phase (Loop) Plots",
        "x_variable": "X variable",
        "y_variable": "Y variable",
        "color_by": "Color by",
        "years": "Years",
        "smoothing_days": "Smoothing (days)",
        "show_markers": "Show markers",
        "select_diff_vars": "Select different variables for X and Y.",
        "ensemble_forecast": "Ensemble forecast (experimental)",
        "enable_ensemble": "Enable ensemble",
        "members_n": "Members (N)",
        "history_window_days": "History window (days)",
        "season_basis_opt": "Season basis",
        "seasonal_smooth_window": "Seasonal smooth window (days)",
        "residual_bootstrap": "Residual block bootstrap",
        "block_length_mode": "Block length mode",
        "block_length": "Block length (days)",
        "quantile_range": "Quantile range",
        "map_title": "Reservoir map: simulated water extent",
        "water_overlay_opacity": "Water overlay opacity",
        "visualization_day": "Visualization day",
        "base_background": "Base background",
        "water_mask_mode": "Water mask mode",
        "simulated_level": "Simulated level",
        "depth_ndwi": "Depth & NDWI",
        "download_csv": "Download scenario CSV",
    "language_label": "Language",
    "initial_volume": "Initial volume",
    "source_label": "Source",
    "min_area_to_volume": "Min area ⇒ volume ≥ {vol:.1f} mcm",
    "reservoir_timeseries_title": "Reservoir Volume Over Time",
    "baseline_volume_name": "Baseline Volume (mcm)",
    "scenario_volume_name": "Scenario Volume (mcm)",
    "date_axis": "Date",
    "volume_axis": "Volume (million m³)",
    "daily_p_et_title": "Daily P and ET Volumes (mcm/day)",
    "p_bar": "P (mcm/day)",
    "et_bar": "ET (mcm/day)",
    "bathymetry_missing": "Bathymetry DEM not found; map overlay disabled.",
    "vol_elev_missing": "Volume→Elevation mapping unavailable (missing elevation_m).",
    "default_sim_level_mode": "Default dynamic simulated level mode.",
    "ndwi_mask_missing": "NDWI mask missing or shape mismatch; showing depth-only water.",
    "dynamic_depth_caption": "Dynamic depth mode: area fraction={frac:.3f}",
    "dem_stats": "DEM stats — min: {dmin:.2f}, max: {dmax:.2f}, mean: {dmean:.2f}",
    "daily": "Daily",
    "loading_data": "Loading data...",
    "footer_caption": "Modular UI – legacy snapshots kept under _legacy/",
    "year": "Year",
    "season_trend_docs": "Season+Trend method (docs)",
    "volume_word": "Volume",
    "mcm_unit": "mcm",
    "dem_label": "DEM",
    "mask_label": "Mask",
    "level_word": "Level",
    "m_unit": "m",
    "removed_rows_area": "{n} ↓ area < {min_area:.1f} km²",
    "curve_missing": "Area-volume curve missing. Run preprocessing pipeline.",
    },
    "kk": {
        "app_title": "Су балансының интерактивті моделі",
        "tagline": "Сценарий симуляциясы және диагностика",
        "lang_ru": "Русский",
        "lang_en": "English",
        "lang_kk": "Қазақ",
        "baseline_info": "Бастапқы дерек",
        "no_baseline": "Бастапқы қатар жоқ – сценарийді есептеуге болады.",
        "scenario_controls": "Сценарий баптауы",
        "data_filtering": "Деректерді сүзу",
        "min_area": "Мин. аумақ (км²)",
        "filter_baseline": "Мин. аумақ бойынша сүзу",
        "hide_below": "Шектен төмен сценарийді жасыру (график)",
        "view_section": "Көрініс",
        "display_range": "Ауқым",
        "all_period": "Барлық кезең",
        "single_year": "Бір жыл",
        "smoothing_window": "Тегістеу терезесі (күн)",
        "forecast_mode": "Болжам режимі",
        "monthly_mean": "Айлық орташа",
        "seasonal_clim": "Маусымдық климатология",
        "seasonal_trend": "Маусым + тренд",
        "season_trend_opts": "Маусым+Тренд параметрлері",
        "history_window": "Тарих терезесі (күн)",
        "season_basis": "Маусым негізі",
        "basis_doy": "Жыл күні",
        "basis_month": "Ай",
        "season_smooth": "Маусымдық тегістеу (күн)",
        "centering": "Орталау",
        "median": "медиана",
        "mean": "орта",
        "clim_missing": "Климатология жоқ: precipitation_volume_mcm және evaporation_volume_mcm қажет.",
        "download": "Сценарий CSV жүктеу",
        "end_volume": "Соңғы көлем (млн м³)",
        "min_volume": "Мин. көлем (млн м³)",
        "max_volume": "Макс. көлем (млн м³)",
        "daily_pet": "Күндік P/ET көлемдері",
        "trends_corr": "Трендтер және корреляциялар",
        "no_scenario_data": "Сценарий деректері жоқ.",
        "rolling_window_days": "Жылжымалы терезе (күн)",
        "max_lag_corr": "Корреляция макс. лагы (күн)",
        "lagged_corr_area": "Аумақпен лагтық корреляциялар",
        "missing_columns": "Талдауға жетіспейтін бағандар: {cols}",
        "long_term_trends": "Ұзақ мерзімді P & ET трендтері",
        "era5_insufficient": "Ұзақ трендтерге ERA5 жеткіліксіз.",
        "years_back": "Жыл артқа",
        "aggregation": "Агрегация",
        "monthly": "Айлық",
        "annual": "Жылдық",
        "not_enough_agg": "Агрегат деректері жеткіліксіз.",
        "p_slope": "P тренді (мм/күн/жыл)",
        "et_slope": "ET тренді (мм/күн/жыл)",
        "snow_temp_trends": "Қар vs Температура",
        "display_agg": "Көрсету агрегациясы",
        "clip_ratio": "Қатынасты ± шектеу",
        "rolling_trends_ratio": "Жылжымалы трендтер және қатынасы",
        "runoff_temp_trends": "Ағын vs Температура",
        "max_lag_temp_runoff": "t→ағын макс. лаг (күн)",
        "lagged_corr_runoff_temp": "Лагтық корреляция: ағын vs температура",
        "p_et_diag": "Жауын-шашын & Булану диагностикасы",
        "p_et_ratio_clip": "P/ET ± шектеу",
        "phase_plots": "Маусымдық фазалық ілмектер",
        "x_variable": "X айнымалысы",
        "y_variable": "Y айнымалысы",
        "color_by": "Түс",
        "years": "Жылдар",
        "smoothing_days": "Тегістеу (күн)",
        "show_markers": "Маркерлерді көрсету",
        "select_diff_vars": "Әр түрлі айнымалыларды таңдаңыз.",
        "ensemble_forecast": "Ансамбль болжамы (эксперимент)",
        "enable_ensemble": "Ансамбльді қосу",
        "members_n": "Мүшелер (N)",
        "history_window_days": "Тарих терезесі (күн)",
        "season_basis_opt": "Маусым негізі",
        "seasonal_smooth_window": "Маусымдық тегістеу терезесі",
        "residual_bootstrap": "Қалдық блок бутстрэп",
        "block_length_mode": "Блок ұзындығы режимі",
        "block_length": "Блок ұзындығы (күн)",
        "quantile_range": "Квантильдер диапазоны",
        "map_title": "Су қоймасы картасы: модельденген су айдыны",
        "water_overlay_opacity": "Су қабаты мөлдірлігі",
        "visualization_day": "Көрсету күні",
        "base_background": "Негізгі фон",
        "water_mask_mode": "Су маска режимі",
        "simulated_level": "Модельденген деңгей",
        "depth_ndwi": "Тереңдік & NDWI",
        "download_csv": "Сценарий CSV жүктеу",
    "language_label": "Тіл",
    "initial_volume": "Бастапқы көлем",
    "source_label": "Дереккөзі",
    "min_area_to_volume": "Мин. аумақ ⇒ көлем ≥ {vol:.1f} млн м³",
    "reservoir_timeseries_title": "Қойма көлемінің динамикасы",
    "baseline_volume_name": "База көлемі (млн м³)",
    "scenario_volume_name": "Сценарий көлемі (млн м³)",
    "date_axis": "Күн",
    "volume_axis": "Көлем (млн м³)",
    "daily_p_et_title": "Күндік P және ET көлемдері (млн м³/күн)",
    "p_bar": "P (млн м³/күн)",
    "et_bar": "ET (млн м³/күн)",
    "bathymetry_missing": "Батиметрия DEM табылмады; карта сөндірілді.",
    "vol_elev_missing": "Көлем→Биіктік сәйкестігі жоқ (elevation_m жоқ).",
    "default_sim_level_mode": "Әдепкі модельденген деңгей режимі.",
    "ndwi_mask_missing": "NDWI маскасы жоқ немесе қате; тек тереңдік (dem<0).",
    "dynamic_depth_caption": "Динамикалық тереңдік режимі: аумақ үлесі={frac:.3f}",
    "dem_stats": "ЦМР статистикасы — min: {dmin:.2f}, max: {dmax:.2f}, mean: {dmean:.2f}",
    "daily": "Күндік",
    "loading_data": "Деректер жүктелуде...",
    "footer_caption": "Модульдік UI – ескі нұсқалар _legacy/ ішінде сақталған",
    "year": "Жыл",
    "season_trend_docs": "Маусым+Тренд әдісі (құжат)",
    "volume_word": "Көлем",
    "mcm_unit": "млн м³",
    "dem_label": "ЦМР",
    "mask_label": "Маска",
    "level_word": "Деңгей",
    "m_unit": "м",
    "removed_rows_area": "{n} ↓ аумақ < {min_area:.1f} км²",
    "curve_missing": "Аумақ-көлем қисығы жоқ. Алдын-ала өңдеуді іске қосыңыз.",
    },
}

DEFAULT_LANG = "ru"

@dataclass
class Translator:
    lang: str = DEFAULT_LANG
    def __post_init__(self):
        if self.lang not in TRANSLATIONS:
            self.lang = DEFAULT_LANG
    def __call__(self, key: str, **fmt):
        bundle = TRANSLATIONS.get(self.lang, {})
        fallback = TRANSLATIONS[DEFAULT_LANG]
        text = bundle.get(key) or fallback.get(key) or key
        if fmt:
            try:
                text = text.format(**fmt)
            except Exception:
                pass
        return text

__all__ = ["Translator", "TRANSLATIONS", "DEFAULT_LANG"]
